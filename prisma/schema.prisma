generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL")
}

enum GroupRole {
  member
  administrator
  creator
}

enum PricingType {
  one_time
  recurring
}

enum PricingPlanInterval {
  day
  week
  month
  year
}

enum SubscriptionStatus {
  trialing
  active
  canceled
  incomplete
  incomplete_expired
  past_due
  unpaid
  paused
}

model User {
  id String @id

  username String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  groupMemberships GroupMember[]
  reminders        Reminder[]
}

model Customer {
  id               String @id
  group            Group  @relation(fields: [id], references: [id])
  stripeCustomerId String @unique
}

model Product {
  id     String  @id
  active Boolean
  name   String

  metadata Json?

  prices Price[]
}

model Price {
  id              String               @id
  active          Boolean
  unitAmount      Int?
  currency        String?              @db.VarChar(3)
  type            PricingType?
  interval        PricingPlanInterval?
  intervalCount   Int?
  trialPeriodDays Int?
  lookupKey       String?

  metadata Json?

  product   Product @relation(fields: [productId], references: [id])
  productId String

  subscriptions Subscription[]
}

model Subscription {
  id                 String             @id
  status             SubscriptionStatus
  quantity           Int?
  cancelAtPeriodEnd  Boolean?
  created            DateTime           @default(now())
  currentPeriodStart DateTime           @default(now())
  currentPeriodEnd   DateTime           @default(now())
  endedAt            DateTime?
  cancelAt           DateTime?
  canceledAt         DateTime?
  trialStart         DateTime?
  trialEnd           DateTime?

  group   Group  @relation(fields: [groupId], references: [id])
  groupId String

  price   Price  @relation(fields: [priceId], references: [id])
  priceId String

  @@index([groupId])
}

enum GroupType {
  private
  group
  supergroup
  channel
}

model Group {
  id   String    @id
  type GroupType

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customer     Customer?
  members      GroupMember[]
  subscription Subscription[]
  usageLogs    UsageLog[]
  reminders    Reminder[]
}

model UsageLog {
  id Int @id @default(autoincrement())

  group   Group  @relation(fields: [groupId], references: [id])
  groupId String

  outputTokens    Int
  voiceMinutes    Int
  imageGeneration Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model GroupMember {
  role     GroupRole
  joinedAt DateTime  @default(now())

  user   User   @relation(fields: [userId], references: [id])
  userId String

  group   Group  @relation(fields: [groupId], references: [id])
  groupId String

  @@id([userId, groupId])
}

enum ReminderStatus {
  SCHEDULED
  CANCELLED
  SENT
}

model Reminder {
  id String @id @default(uuid())

  messageId String @unique

  message   String
  remindAt  DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  timezone  String

  status ReminderStatus

  user   User   @relation(fields: [userId], references: [id])
  userId String

  group   Group  @relation(fields: [groupId], references: [id])
  groupId String
}
