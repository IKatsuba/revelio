generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL")
}

enum GroupRole {
  member
  administrator
  creator
}

enum PricingType {
  one_time
  recurring
}

enum PricingPlanInterval {
  day
  week
  month
  year
}

enum SubscriptionStatus {
  trialing
  active
  canceled
  incomplete
  incomplete_expired
  past_due
  unpaid
  paused
}

model User {
  id Int @id

  username String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  groupMemberships GroupMember[]
}

model Customer {
  id               Int    @id
  group            Group  @relation(fields: [id], references: [id])
  stripeCustomerId String @unique
}

model Product {
  id     String  @id
  active Boolean
  name   String  @unique

  metadata Json?

  prices Price[]
}

model Price {
  id              String               @id
  active          Boolean
  unitAmount      Int?
  currency        String?              @db.VarChar(3)
  type            PricingType?
  interval        PricingPlanInterval?
  intervalCount   Int?
  trialPeriodDays Int?
  lookupKey       String?

  metadata Json?

  product   Product @relation(fields: [productId], references: [id])
  productId String

  subscriptionOnPrice SubscriptionOnPrice[]
}

model Subscription {
  id                 String             @id
  status             SubscriptionStatus
  quantity           Int?
  cancelAtPeriodEnd  Boolean?
  created            DateTime           @default(now())
  currentPeriodStart DateTime           @default(now())
  currentPeriodEnd   DateTime           @default(now())
  endedAt            DateTime?
  cancelAt           DateTime?
  canceledAt         DateTime?
  trialStart         DateTime?
  trialEnd           DateTime?

  group   Group @relation(fields: [groupId], references: [id])
  groupId Int

  subscriptionOnPrice SubscriptionOnPrice[]

  @@index([groupId])
}

model SubscriptionOnPrice {
  id Int @id @default(autoincrement())

  subscription   Subscription @relation(fields: [subscriptionId], references: [id])
  subscriptionId String

  price   Price  @relation(fields: [priceId], references: [id])
  priceId String

  @@unique([subscriptionId, priceId])
}

enum GroupType {
  private
  group
  supergroup
  channel
}

model Group {
  id   Int       @id
  type GroupType

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customer     Customer?
  members      GroupMember[]
  subscription Subscription[]
  usageLogs    UsageLog[]
}

model UsageLog {
  id Int @id @default(autoincrement())

  group   Group @relation(fields: [groupId], references: [id])
  groupId Int

  outputTokens    Int
  voiceMinutes    Int
  imageGeneration Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model GroupMember {
  id       Int       @id @default(autoincrement())
  role     GroupRole
  joinedAt DateTime  @default(now())

  user   User @relation(fields: [userId], references: [id])
  userId Int

  group   Group @relation(fields: [groupId], references: [id])
  groupId Int

  @@unique([userId, groupId])
}
